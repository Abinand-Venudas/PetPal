{% extends "user/base.html" %}
{% load static %}

{% block title %}Pet Grooming{% endblock %}

{% block extra_css %}
<style>
/* ================= THEME VARIABLES ================= */
:root{
  --bg-main:#f4f6ff;
  --bg-card:#ffffff;
  --text-main:#0f172a;
  --text-sub:#64748b;
  --border:#e5e7eb;
  --input-bg:#f9fafb;
  --slot-bg:#eef2ff;
  --slot-text:#3730a3;
  --slot-disabled:#f1f5f9;
  --summary-grad:linear-gradient(135deg,#6366f1,#ec4899);
}

.dark{
  --bg-main:#0b1220;
  --bg-card:#0f172a;
  --text-main:#f9fafb;
  --text-sub:#94a3b8;
  --border:#1e293b;
  --input-bg:#020617;
  --slot-bg:#1e293b;
  --slot-text:#c7d2fe;
  --slot-disabled:#020617;
  --summary-grad:linear-gradient(135deg,#4f46e5,#db2777);
}

/* ================= LAYOUT ================= */
.page-wrap{background:var(--bg-main);min-height:100vh;}
.card{
  background:var(--bg-card);
  border-radius:26px;
  box-shadow:0 25px 80px rgba(0,0,0,.08);
  padding:60px;
  color:var(--text-main);
}

/* ================= TEXT ================= */
.section-title{font-size:22px;font-weight:800;margin-bottom:8px;}
.label{font-size:13px;font-weight:600;color:var(--text-sub);margin-bottom:6px;}
h1,p{color:var(--text-main);}
p{color:var(--text-sub);}

/* ================= GRID ================= */
.grid-2{display:grid;grid-template-columns:repeat(2,1fr);gap:20px;}
.grid-3{display:grid;grid-template-columns:repeat(3,1fr);gap:20px;}
.grid-1{display:grid;grid-template-columns:1fr;gap:20px;}

/* ================= INPUTS ================= */
.input,.select,.textarea{
  width:100%;
  padding:15px 16px;
  border-radius:14px;
  border:1px solid var(--border);
  background:var(--input-bg);
  font-size:14px;
  color:var(--text-main);
}
.input:focus,.select:focus,.textarea:focus{
  outline:none;border-color:#6366f1;background:var(--bg-card);
}

/* ================= SERVICES ================= */
.service-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:20px;}
.service-card{
  display:flex;align-items:center;gap:16px;
  padding:18px 22px;border-radius:18px;
  border:1px solid var(--border);
  background:var(--bg-card);
  cursor:pointer;transition:.25s;
}
.service-card:hover{transform:translateY(-2px);box-shadow:0 12px 30px rgba(0,0,0,.15);}
.service-card.active{border:2px solid #6366f1;box-shadow:0 12px 35px rgba(99,102,241,.35);}
.service-card input{display:none;}
.service-icon{
  width:44px;height:44px;border-radius:50%;
  background:linear-gradient(135deg,#6366f1,#8b5cf6);
  display:flex;align-items:center;justify-content:center;color:#fff;
}
.service-price{margin-left:auto;font-weight:700;}

/* ================= SLOTS ================= */
.slots{display:grid;grid-template-columns:repeat(auto-fill,minmax(95px,1fr));gap:14px;min-height:120px;}
.slot{
  padding:12px 0;border-radius:14px;text-align:center;
  font-weight:600;font-size:14px;
  background:var(--slot-bg);color:var(--slot-text);
  cursor:pointer;transition:.2s;
}
.slot:hover{transform:scale(1.05);}
.slot.active{background:linear-gradient(135deg,#6366f1,#8b5cf6);color:#fff;}
.slot.disabled{
  background:var(--slot-disabled);color:#64748b;
  cursor:not-allowed;pointer-events:none;opacity:.5;
}

/* ================= SUMMARY ================= */
.summary{
  background:var(--summary-grad);
  border-radius:22px;
  padding:28px 34px;
  display:flex;justify-content:space-between;align-items:center;
  color:#fff;margin-top:40px;
}
.price{font-size:36px;font-weight:900;}
.book-btn{
  background:#fff;color:#4f46e5;border:none;
  padding:15px 40px;border-radius:16px;
  font-weight:800;cursor:pointer;transition:.2s;
}
.book-btn:hover{transform:translateY(-2px);box-shadow:0 10px 25px rgba(255,255,255,.4);}
</style>
{% endblock %}

{% block content %}
<div class="page-wrap py-20 px-6">
<div class="max-w-6xl mx-auto card">

<h1 class="text-4xl font-extrabold text-center mb-3">Professional Pet Grooming</h1>
<p class="text-center mb-16">Premium care ‚Ä¢ Smart scheduling ‚Ä¢ Trusted service</p>

<form method="POST">
{% csrf_token %}

<!-- PET DETAILS -->
<div class="mb-16">
  <div class="section-title">Pet Information</div>

  <div class="grid-3">
    <div>
      <div class="label">Animal Type</div>
      <select name="animal_type" class="select" required>
        <option value="">Select</option>
        <option value="Dog" {% if prefill.animal_type == "Dog" %}selected{% endif %}>Dog</option>
        <option value="Cat" {% if prefill.animal_type == "Cat" %}selected{% endif %}>Cat</option>
        <option value="Rabbit" {% if prefill.animal_type == "Rabbit" %}selected{% endif %}>Rabbit</option>
        <option value="Bird" {% if prefill.animal_type == "Bird" %}selected{% endif %}>Bird</option>
        <option value="Other" {% if prefill.animal_type == "Other" %}selected{% endif %}>Other</option>
      </select>
    </div>

    <div>
      <div class="label">Pet Name</div>
      <input type="text" name="pet_name" class="input" value="{{ prefill.pet_name|default:'' }}" required>
    </div>

    <div>
      <div class="label">Breed</div>
      <input type="text" name="breed" class="input" value="{{ prefill.breed|default:'' }}">
    </div>
  </div>

  <div class="grid-3 mt-5">
    <div><div class="label">Age</div><input type="number" name="age" class="input" value="{{ prefill.age|default:'' }}"></div>
    <div><div class="label">Weight</div><input type="number" step="0.1" name="weight" class="input" value="{{ prefill.weight|default:'' }}"></div>
    <div><div class="label">Special Condition</div><input type="text" name="condition" class="input" value="{{ prefill.condition|default:'' }}"></div>
  </div>
</div>

<!-- GUARDIAN -->
<div class="mb-16">
  <div class="section-title">Guardian Information</div>

  <div class="grid-2">
    <div><div class="label">Guardian Name</div><input type="text" name="guardian_name" class="input" value="{{ prefill.guardian_name|default:'' }}" required></div>
    <div><div class="label">Guardian Phone</div><input type="tel" name="guardian_phone" class="input" value="{{ prefill.guardian_phone|default:'' }}" required></div>
  </div>

  <div class="grid-2 mt-5">
    <div><div class="label">Emergency Contact</div><input type="tel" name="emergency_contact" class="input" value="{{ prefill.emergency_contact|default:'' }}"></div>
    <div><div class="label">Email</div><input type="email" name="email" class="input" value="{{ prefill.email|default:'' }}"></div>
  </div>

  <div class="grid-1 mt-5">
    <div><div class="label">Address</div><textarea name="address" class="textarea">{{ prefill.address|default:'' }}</textarea></div>
  </div>
</div>

<!-- SERVICES -->
<div class="mb-16">
  <div class="section-title">Grooming Services</div>

  <div class="service-grid">
  {% for service in services %}
    <label class="service-card {% if prefill.services and service.id in prefill.services %}active{% endif %}">
      <input type="checkbox"
             name="services"
             value="{{ service.id }}"
             data-price="{{ service.price }}"
             data-duration="{{ service.duration }}"
             {% if prefill.services and service.id in prefill.services %}checked{% endif %}>
      <div class="service-icon">üêæ</div>
      <div>
        <div class="service-name">{{ service.name }}</div>
        <div class="service-time">{{ service.duration }} min</div>
      </div>
      <div class="service-price">‚Çπ{{ service.price }}</div>
    </label>
  {% endfor %}
  </div>
</div>

<!-- DATE -->
<div class="mb-12">
  <div class="section-title">Appointment Date</div>
  <input type="date" id="dateInput" name="date" class="input" required>
</div>

<!-- TIME -->
<div class="mb-12">
  <div class="section-title">Time Slot</div>
  <div class="slots" id="slotContainer"></div>
  <input type="hidden" name="time" id="timeField" required>
</div>

<!-- NOTES -->
<div class="mb-12">
  <div class="section-title">Special Instructions</div>
  <textarea name="instructions" class="textarea">{{ prefill.instructions|default:'' }}</textarea>
</div>

<!-- SUMMARY -->
<div class="summary">
  <div>
    <div>Total Estimate</div>
    <div id="total" class="price">‚Çπ0</div>
    <div id="duration">0 min</div>
  </div>
  <button class="book-btn">Confirm Booking</button>
</div>

</form>
</div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let bookedSlots = {};
try{ bookedSlots = JSON.parse('{{ booked_slots|escapejs }}'); }catch(e){ bookedSlots = {}; }

const slotContainer=document.getElementById("slotContainer");
const dateInput=document.getElementById("dateInput");
const timeField=document.getElementById("timeField");

const today=new Date();
const todayStr=today.toISOString().split("T")[0];
dateInput.min=todayStr;

const OPEN=10*60, CLOSE=22*60, STEP=60;

function toMin(t){let[a,b]=t.split(":");return (+a)*60+(+b);}
function toTime(m){return String(Math.floor(m/60)).padStart(2,"0")+":00";}
function format(t){let h=parseInt(t);let am=h>=12?"PM":"AM";h=h%12||12;return h+":00 "+am;}

function generateSlots(){let arr=[];for(let m=OPEN;m<CLOSE;m+=STEP)arr.push(toTime(m));return arr;}

function recalc(){
  let total=0,duration=0;
  document.querySelectorAll("input[type=checkbox]:checked").forEach(i=>{
    total+=Number(i.dataset.price);
    duration+=Number(i.dataset.duration);
  });
  document.getElementById("total").innerText="‚Çπ"+total;
  document.getElementById("duration").innerText=duration+" min";
}

function renderSlots(date){
  slotContainer.innerHTML="";
  let duration=0;
  document.querySelectorAll("input[type=checkbox]:checked").forEach(i=>duration+=Number(i.dataset.duration));
  if(duration===0){
    slotContainer.innerHTML=`<div style="grid-column:1/-1;text-align:center;color:#94a3b8;">Select services first</div>`;
    return;
  }

  const now=new Date();
  const nowMin=now.getHours()*60+now.getMinutes();
  const isToday=date===todayStr;
  const booked=bookedSlots[date]||[];

  generateSlots().forEach(t=>{
    const start=toMin(t), end=start+duration;
    let blocked=false;
    if(isToday && start<=nowMin) blocked=true;
    if(end>CLOSE) blocked=true;
    booked.forEach(b=>{
      const bs=toMin(b.start), be=toMin(b.end);
      if(start<be && end>bs) blocked=true;
    });

    const div=document.createElement("div");
    div.className="slot";
    div.innerText=format(t);
    if(blocked){div.classList.add("disabled");}
    else{
      div.onclick=()=>{
        document.querySelectorAll(".slot").forEach(s=>s.classList.remove("active"));
        div.classList.add("active");
        timeField.value=t;
      }
    }
    slotContainer.appendChild(div);
  });
}

slotContainer.innerHTML=`<div style="grid-column:1/-1;text-align:center;color:#94a3b8;">Select services and date</div>`;

dateInput.addEventListener("change",()=>{timeField.value="";renderSlots(dateInput.value);});

document.querySelectorAll(".service-card").forEach(card=>{
  const cb=card.querySelector("input");
  card.onclick=()=>{
    cb.checked=!cb.checked;
    card.classList.toggle("active",cb.checked);
    recalc();
    timeField.value="";
    if(dateInput.value) renderSlots(dateInput.value);
  }
});

// initial calculation for rebook
recalc();
</script>
{% endblock %}
