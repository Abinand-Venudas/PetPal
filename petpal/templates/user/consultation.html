{% extends "user/base.html" %}
{% load static %}

{% block title %}PetPal — Premium Consultation{% endblock %}

{% block extra_css %}
<style>
/* ================= VIDEO BACKGROUND ================= */
.video-bg{
  position:fixed;
  inset:0;
  width:100vw;
  height:100vh;
  overflow:hidden;
  z-index:-10;
}
.video-bg video{
  width:100%;
  height:100%;
  object-fit:cover;
}
.video-bg::after{
  content:"";
  position:absolute;
  inset:0;
  background:linear-gradient(180deg,rgba(255,255,255,0.55),rgba(255,255,255,0.8));
}
.dark .video-bg::after{
  background:linear-gradient(180deg,rgba(2,6,23,0.75),rgba(2,6,23,0.9));
}

/* Ensure page content scrolls above video */
body{
  position:relative;
}

/* ================= INPUT ================= */
.input{
  width:100%;
  padding:16px 48px 16px 18px;
  border-radius:18px;
  border:1.5px solid #e5e7eb;
  background:#fff;
  color:#111827;
}
.dark .input{
  background:rgba(15,23,42,.95);
  border-color:#334155;
  color:#f8fafc;
}
.dark .input::placeholder{color:#94a3b8;}

/* ================= ICON INPUT ================= */
.input-wrapper{position:relative;}
.input-icon{
  position:absolute;
  right:16px;
  top:50%;
  transform:translateY(-50%);
  font-size:18px;
  cursor:pointer;
  z-index:10;
  color:#6d28d9;
  pointer-events:auto;
  transition:all .25s ease;
}
.input-icon:hover{color:#ec4899;}
.dark .input-icon{color:#f8fafc !important;opacity:0.95;}
.dark .input-icon:hover{color:#f472b6 !important;}

.input-wrapper:focus-within .input-icon{
  color:#ec4899;
  text-shadow:0 0 8px rgba(236,72,153,.6);
}
.dark .input-wrapper:focus-within .input-icon{
  color:#f472b6;
  text-shadow:0 0 10px rgba(244,114,182,.8);
}

input[type="date"]::-webkit-calendar-picker-indicator{
  opacity:0;
  display:none;
}

/* ================= DOCTOR CARD ================= */
.doc-card{
  cursor:pointer;
  padding:18px;
  border-radius:26px;
  background:white;
  border:1px solid #eef2ff;
  transition:.35s;
  text-align:center;
}
.dark .doc-card{
  background:rgba(30,41,59,.9);
  border:1px solid rgba(255,255,255,.08);
}
.doc-card:hover{transform:translateY(-8px);}
.dark .doc-card h3{color:#f8fafc;}
.dark .doc-card p{color:#cbd5f5;}

input[type="radio"]{display:none}
input[type="radio"]:checked + .doc-card{
  border-color:#7c3aed;
  box-shadow:0 35px 70px rgba(124,58,237,.35);
}

/* ================= BUTTON ================= */
.primary-btn{
  background:#6d28d9;
  color:white;
  border-radius:18px;
  padding:18px;
  font-weight:600;
}
.primary-btn:disabled{
  opacity:0.6;
  cursor:not-allowed;
}

/* ================= DISABLED DAY STYLE ================= */
.input.disabled-day{
  border-color:#ef4444 !important;
  box-shadow:0 0 0 3px rgba(239,68,68,.25);
}
.dark .input.disabled-day{
  border-color:#f87171 !important;
  box-shadow:0 0 0 3px rgba(248,113,113,.35);
}
</style>
{% endblock %}

{% block content %}

<!-- ===== FULLSCREEN VIDEO BACKGROUND ===== -->
<div class="video-bg">
  <video autoplay muted loop playsinline>
    <source src="{% static 'img/vet.MP4' %}" type="video/mp4">
  </video>
</div>

<section class="max-w-7xl mx-auto px-6 pt-28 text-center relative z-10">
  <h1 class="text-6xl font-extrabold">Veterinary Consultation</h1>
  <p class="mt-4 text-lg max-w-2xl mx-auto">Premium care from certified professionals</p>
</section>

<section class="px-6 md:px-20 py-20 relative z-10">
  <div class="glass max-w-5xl mx-auto p-14">

<!-- ================= LOGIN NOTICE ================= -->
{% if not request.session.user_id %}
<div class="mb-10 p-6 rounded-2xl bg-yellow-50 border border-yellow-200 text-yellow-800 text-center">
  <p class="text-lg font-semibold">You can explore this page without logging in.</p>
  <p class="mt-2">To book a consultation, please log in.</p>
  <a href="{% url 'petapp:login' %}" class="inline-block mt-4 px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition">
    Login to Continue
  </a>
</div>
{% endif %}

<form method="post">
{% csrf_token %}

<!-- PET INFO -->
<div class="mb-16">
  <h2 class="text-3xl font-bold mb-6">Pet Information</h2>
  <div class="grid md:grid-cols-3 gap-6">
    <input class="input" name="pet_name" placeholder="Pet Name" required>
    <select class="input" name="pet_type">
      <option>Dog</option><option>Cat</option><option>Other</option>
    </select>
    <input class="input" type="number" name="age" placeholder="Age" required>
  </div>
  <textarea class="input mt-6" rows="3" name="issue" placeholder="Describe the issue" required></textarea>
</div>

<!-- DOCTOR SELECTION -->
<div class="mb-16">
  <h2 class="text-3xl font-bold mb-6">Select a Doctor</h2>
  <div class="grid sm:grid-cols-2 lg:grid-cols-3 gap-8">
    {% for d in dc %}
    <label>
      <input type="radio" name="doctor_id" value="{{ d.id }}" required>
      <div class="doc-card">
        {% if d.image %}
          <img src="{{ d.image.url }}" class="w-full h-44 object-cover rounded-2xl">
        {% else %}
          <img src="https://images.unsplash.com/photo-1607746882042-944635dfe10e"
               class="w-full h-44 object-cover rounded-2xl">
        {% endif %}
        <h3 class="mt-4 text-lg font-semibold">Dr. {{ d.name }}</h3>
        <p class="text-sm text-gray-500 dark:text-gray-400">
          {{ d.specialization }} · {{ d.experience }} yrs
        </p>
      </div>
    </label>
    {% endfor %}
  </div>
</div>

<!-- SCHEDULE -->
<div class="mb-16">
  <h2 class="text-3xl font-bold mb-6">Schedule</h2>
  <div class="grid md:grid-cols-2 gap-6">

    <div class="input-wrapper">
      <input type="date" id="consultDate" name="date" class="input" required>
      <i class="fa-solid fa-calendar-days input-icon"
         onclick="document.getElementById('consultDate').showPicker()"></i>
    </div>

    <div class="input-wrapper">
      <select id="consultTime" name="time" class="input" required>
        <option value="">Select Time</option>
      </select>
      <i class="fa-solid fa-clock input-icon"></i>
    </div>

  </div>
  <p class="text-sm text-gray-500 dark:text-gray-400 mt-3">
    Fully booked days are highlighted. Only available slots are shown.
  </p>
</div>

<!-- ================= SUBMIT ================= -->
{% if request.session.user_id %}
  <button class="w-full primary-btn">Confirm Consultation</button>
{% else %}
  <button class="w-full primary-btn" disabled>Login to Book Consultation</button>
{% endif %}

</form>
</div>
</section>

{% endblock %}

{% block extra_js %}
<script>
document.addEventListener("DOMContentLoaded", function () {

  const dateInput = document.getElementById("consultDate");
  const timeSelect = document.getElementById("consultTime");
  const doctorRadios = document.querySelectorAll("input[name='doctor_id']");

  const ALL_TIMES = [
    "10:00","11:00","12:00","13:00","14:00",
    "15:00","16:00","17:00","18:00",
    "19:00","20:00","21:00","22:00"
  ];

  const today = new Date().toISOString().split("T")[0];
  dateInput.setAttribute("min", today);

  async function fetchBooked(date) {
    const res = await fetch(`/api/booked-slots/?date=${date}`);
    return await res.json();
  }

  async function updateTimeSlots() {
    const date = dateInput.value;
    const selectedDoctor = document.querySelector("input[name='doctor_id']:checked");

    timeSelect.innerHTML = '<option value="">Select Time</option>';
    dateInput.classList.remove("disabled-day");

    if (!date || !selectedDoctor) return;

    const bookedData = await fetchBooked(date);
    const doctorId = selectedDoctor.value;
    const booked = bookedData[doctorId] || [];

    let available = false;

    ALL_TIMES.forEach(t => {
      if (!booked.includes(t)) {
        const opt = document.createElement("option");
        opt.value = t;
        opt.textContent = t;
        timeSelect.appendChild(opt);
        available = true;
      }
    });

    if (!available) {
      const opt = document.createElement("option");
      opt.value = "";
      opt.textContent = "No slots available";
      opt.disabled = true;
      timeSelect.appendChild(opt);
      dateInput.classList.add("disabled-day");
    }
  }

  dateInput.addEventListener("change", updateTimeSlots);
  doctorRadios.forEach(radio => {
    radio.addEventListener("change", updateTimeSlots);
  });

});
</script>
{% endblock %}
