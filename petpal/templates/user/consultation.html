{% extends "user/base.html" %}
{% load static %}

{% block title %}Pawfect â€” Book Consultation{% endblock %}

{% block extra_css %}
<style>
/* ================= VARIABLES ================= */
:root{
  --accent:#6366f1;
  --accent-soft:rgba(99,102,241,.1);
  --accent-glow:rgba(99,102,241,.35);

  --bg-page:#f8fafc;
  --surface:#ffffff;
  --surface-soft:#f9fafb;

  --text-main:#0f172a;
  --text-muted:#64748b;

  --border-light:#e2e8f0;

  --radius-xl:28px;
  --radius-md:16px;

  --shadow-soft:0 12px 40px -12px rgba(0,0,0,.12);
  --transition:all .25s ease;
}

/* ================= DARK MODE ================= */
.dark{
  --bg-page:#020617;
  --surface:#0f172a;
  --surface-soft:#0b1220;

  --text-main:#f8fafc;
  --text-muted:#94a3b8;

  --border-light:#1e293b;
}

/* ================= PAGE ================= */
.page-container{
  max-width:1000px;
  margin:0 auto;
  padding:60px 24px 200px;
}

/* ================= SECTION ================= */
.section-wrapper{
  background:var(--surface);
  border:1px solid var(--border-light);
  border-radius:var(--radius-xl);
  padding:42px;
  margin-bottom:44px;
  box-shadow:var(--shadow-soft);
}

/* ================= SECTION HEADER ================= */
.section-head{
  margin-bottom:28px;
}

.section-head span{
  font-size:.75rem;
  font-weight:700;
  letter-spacing:.08em;
  color:var(--accent);
  text-transform:uppercase;
}

.section-head h2{
  font-size:1.4rem;
  margin-top:6px;
  color:var(--text-main);
}

.section-head p{
  margin-top:6px;
  color:var(--text-muted);
  font-size:.95rem;
}

/* ================= DOCTORS ================= */
.doc-grid{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(280px,1fr));
  gap:24px;
}

.doc-card{
  position:relative;
  background:var(--surface-soft);
  border-radius:18px;
  padding:20px;
  display:flex;
  gap:18px;
  align-items:center;
  border:2px solid transparent;
  cursor:pointer;
  transition:var(--transition);
}

.doc-card:hover{
  transform:translateY(-4px);
}

.doc-card.active{
  border-color:var(--accent);
  background:linear-gradient(to right,var(--accent-soft),transparent);
}

.doc-avatar{
  width:72px;
  height:72px;
  border-radius:16px;
  object-fit:cover;
  background:#c7d2fe;
}

/* ================= AVAILABILITY BADGE ================= */
.doc-status{
  position:absolute;
  top:14px;
  right:14px;
  font-size:.7rem;
  font-weight:800;
  padding:6px 12px;
  border-radius:999px;
  background:#dcfce7;
  color:#166534;
}

/* ================= AVAILABILITY ================= */
.availability-header{
  display:none;
  margin-bottom:24px;
  padding:22px;
  border-radius:18px;
  background:linear-gradient(135deg,rgba(99,102,241,.15),rgba(236,72,153,.15));
  border:1px solid var(--border-light);
}

/* ================= DATE & TIME ================= */
.date-time-container{
  display:grid;
  grid-template-columns:1fr 1.5fr;
  gap:32px;
}

@media(max-width:768px){
  .date-time-container{grid-template-columns:1fr}
}

input[type="date"]{
  width:100%;
  padding:16px;
  border-radius:14px;
  background:var(--surface);
  border:1px solid var(--border-light);
  color:var(--text-main);
  font-weight:600;
}

/* ================= SLOTS ================= */
.slots-grid{
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(90px,1fr));
  gap:12px;
}

.slot-btn{
  padding:12px 0;
  border-radius:12px;
  background:var(--surface);
  border:1px solid var(--border-light);
  font-weight:600;
  cursor:pointer;
}

.slot-btn.active{
  background:var(--accent);
  color:#fff;
  border-color:var(--accent);
}

.slot-btn:disabled{
  opacity:.35;
  cursor:not-allowed;
}

/* ================= ACTION BAR ================= */
.action-bar{
  position:fixed;
  bottom:24px;
  left:50%;
  transform:translateX(-50%);
  background:#020617;
  border-radius:999px;
  padding:10px 10px 10px 28px;
  display:flex;
  gap:28px;
  color:#fff;
}

.btn-book{
  background:#fff;
  color:#020617;
  border:none;
  padding:14px 42px;
  border-radius:999px;
  font-weight:800;
  cursor:pointer;
}

.btn-book:disabled{
  opacity:.5;
}
/* ================= STEP 03 FIX ================= */

.intake-card{
  background:var(--surface-soft);
  border:1px solid var(--border-light);
  border-radius:20px;
  padding:28px;
}

.form-grid{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:22px;
}

@media(max-width:600px){
  .form-grid{
    grid-template-columns:1fr;
  }
}

.form-field{
  display:flex;
  flex-direction:column;
  gap:6px;
}

.form-field.full-width{
  margin-top:20px;
}

.form-field label{
  font-size:.85rem;
  font-weight:600;
  color:var(--text-muted);
}

.form-field input,
.form-field textarea{
  padding:14px;
  border-radius:14px;
  background:var(--surface);
  border:1px solid var(--border-light);
  color:var(--text-main);
  font-weight:600;
}

.form-field textarea{
  min-height:120px;
  resize:none;
}

</style>
{% endblock %}

{% block content %}
<div class="page-container">
<form method="POST" action="{% url 'petapp:bookAppointment' %}">
{% csrf_token %}

<input type="hidden" id="doctorId" name="doctor_id">
<input type="hidden" id="bookingDate" name="date">
<input type="hidden" id="bookingTime" name="time">

<!-- STEP 01 -->
<div class="section-wrapper">
  <div class="section-head">
    <span>Step 01</span>
    <h2>Select a Specialist</h2>
    <p>Only doctors who are currently checked-in are shown</p>
  </div>

  <div class="doc-grid">

    {% for doctor in dc %}
      {% if doctor.is_available %}
      <div class="doc-card"
        onclick="selectDoctor(this,'{{ doctor.id }}','{{ doctor.name }}','{{ doctor.specialization|default:"Veterinarian" }}','{{ doctor.experience|default:"0" }}')">

        <span class="doc-status">Available</span>

        {% if doctor.image %}
          <img src="{{ doctor.image.url }}" class="doc-avatar">
        {% else %}
          <div class="doc-avatar"></div>
        {% endif %}

        <div>
          <strong>Dr. {{ doctor.name }}</strong><br>
          <small>{{ doctor.specialization|default:"Veterinarian" }}</small>
        </div>
      </div>
      {% endif %}
    {% empty %}
      <p style="opacity:.6">No doctors are currently available.</p>
    {% endfor %}

  </div>
</div>

<!-- STEP 02 -->
<div class="section-wrapper">
  <div class="section-head">
    <span>Step 02</span>
    <h2>Choose Date & Time</h2>
    <p>Select an available appointment slot</p>
  </div>

  <div class="availability-header" id="doctorInfo">
    <strong id="docName"></strong><br>
    <span id="docMeta"></span>
  </div>

  <div class="date-time-container">
    <input type="date" id="dateInput" required oninput="handleDateChange(this.value)">
    <div class="slots-grid" id="slotGrid"></div>
  </div>
</div>

<!-- STEP 03 -->
<div class="section-wrapper">
  <div class="section-head">
    <span>Step 03</span>
    <h2>Patient Intake</h2>
    <p>Tell us about your pet and the issue</p>
  </div>

  <div class="intake-card">
    <div class="form-grid">
      <div class="form-field">
        <label>Pet Name</label>
        <input name="pet_name" required>
      </div>

      <div class="form-field">
        <label>Pet Type</label>
        <input name="pet_type" required>
      </div>
    </div>

    <div class="form-field full-width">
      <label>Describe your petâ€™s issue</label>
      <textarea name="reason" required></textarea>
    </div>
  </div>
</div>

<!-- ACTION BAR -->

<div class="action-bar">
  <div>
    <strong id="barDoc">Select doctor</strong><br>
    <span id="barDate">Select date & time</span>
  </div>
  <button class="btn-book" type="submit" disabled>
    Confirm Consultation
  </button>
</div>

</form>
</div>
{% endblock %}

{% block extra_js %}
<script>
  window.addEventListener("beforeunload", () => {
  if(state.doctor && state.date && state.time){
    releaseSlot(state.time);
  }
});

let state = { doctor:null, date:null, time:null };
let bookedSlots = {};   // ðŸ”’ holds backend data

const slots = [
 "08:00","08:30","09:00","09:30","10:00","10:30",
 "11:00","11:30","14:00","14:30","15:00","15:30",
 "16:00","16:30","17:00","18:00"
];

const slotGrid  = document.getElementById("slotGrid");
const btn       = document.querySelector(".btn-book");
const dateInput = document.getElementById("dateInput");

const TODAY = new Date().toISOString().split("T")[0];
dateInput.min = TODAY;

/* ================= DOCTOR ================= */
function selectDoctor(el,id,name,spec,exp){
  document.querySelectorAll(".doc-card").forEach(c=>c.classList.remove("active"));
  el.classList.add("active");

  doctorId.value = id;
  state.doctor = id;   // ðŸ”¥ store doctor ID, not name

  doctorInfo.style.display = "block";
  doctorInfo.classList.add("active");
  docName.innerText = "Dr. " + name;
  docMeta.innerText = `${spec} â€¢ ${exp} years experience`;

  if(state.date){
    fetchBookedSlots();   // ðŸ”¥ refetch when doctor changes
  }

  updateUI();
}

/* ================= DATE ================= */
function handleDateChange(value){
  if(value < TODAY){
    dateInput.value = TODAY;
    value = TODAY;
  }

  state.date = value;
  bookingDate.value = value;

  fetchBookedSlots();   // ðŸ”¥ fetch slots from backend
}

/* ================= FETCH BOOKED SLOTS ================= */
function fetchBookedSlots(){
  slotGrid.innerHTML = "<p style='opacity:.6'>Loading slotsâ€¦</p>";

  fetch(`/api/booked-slots/?date=${state.date}`)
    .then(res => res.json())
    .then(data => {
      bookedSlots = data;   // { doctor_id: [times] }
      renderSlots();
      updateUI();
    })
    .catch(err => {
      console.error("Slot fetch failed", err);
      slotGrid.innerHTML = "<p>Error loading slots</p>";
    });
}

/* ================= RENDER SLOTS ================= */
function renderSlots(){
  slotGrid.innerHTML = "";
  state.time = null;
  bookingTime.value = "";

  const now = new Date();
  const doctorBooked = bookedSlots[state.doctor] || [];

  slots.forEach(t=>{
    const b = document.createElement("button");
    b.type = "button";
    b.className = "slot-btn";
    b.innerText = t;

    const slotTime = new Date(state.date + "T" + t);

    /* â›” Past time */
    if(state.date === TODAY && slotTime <= now){
      b.disabled = true;
    }

    /* â›” Already booked */
    if(doctorBooked.includes(t)){
      b.disabled = true;
      b.style.opacity = "0.35";
    }

    b.onclick = ()=>{
  if(b.disabled) return;

  /* ðŸ”“ Release previous lock */
  if(state.time){
    releaseSlot(state.time);
  }

  /* ðŸ” Lock this slot */
  lockSlot(t, b);
};


    slotGrid.appendChild(b);
  });
}

/* ================= LOCK SLOT ================= */
function lockSlot(time, button){
  fetch("/api/lock-slot/", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "X-CSRFToken": getCSRFToken()
    },
    body: JSON.stringify({
      doctor_id: state.doctor,
      date: state.date,
      time: time
    })
  })
  .then(res => res.json())
  .then(data => {
    if(!data.success){
      alert(data.message || "Slot unavailable");
      fetchBookedSlots(); // refresh grid
      return;
    }

    document.querySelectorAll(".slot-btn").forEach(x=>x.classList.remove("active"));
    button.classList.add("active");

    state.time = time;
    bookingTime.value = time;

    updateUI();
  });
}

/* ================= RELEASE SLOT ================= */
function releaseSlot(time){
  fetch("/api/release-slot/", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "X-CSRFToken": getCSRFToken()
    },
    body: JSON.stringify({
      doctor_id: state.doctor,
      date: state.date,
      time: time
    })
  });
}

/* ================= CSRF ================= */
function getCSRFToken(){
  return document.querySelector("[name=csrfmiddlewaretoken]").value;
}


/* ================= ACTION BAR ================= */
function updateUI(){
  barDoc.innerText = state.doctor ? "Doctor selected" : "Select doctor";
  barDate.innerText =
    state.date && state.time
      ? `${state.date} @ ${state.time}`
      : "Select date & time";

  btn.disabled = !(state.doctor && state.date && state.time);
}
</script>
{% endblock %}
