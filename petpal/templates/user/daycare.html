{% extends "user/base.html" %}
{% load static %}

{% block title %}PetPal â€” Daycare{% endblock %}

{% block extra_css %}
<style>
:root{
  --pink:#ec4899;
  --purple:#8b5cf6;
  --blur:blur(18px);
}

/* ================= DARK MODE ================= */
.dark body{background:#0b1220 !important;color:#f9fafb !important;}
.dark .card{background:#020617 !important;border:1px solid rgba(255,255,255,.12)!important;}
.dark .input,.dark select.input{background:#020617!important;color:#fff!important;border:1px solid rgba(255,255,255,.18)!important;}
.dark .summary{background:#020617!important;border:1px solid rgba(255,255,255,.15)!important;}
.dark .time-btn{background:#020617!important;color:#fff!important;border:1px solid rgba(255,255,255,.18)!important;}
.dark .time-btn.active{background:linear-gradient(135deg,var(--pink),var(--purple))!important;color:#fff!important;}
.dark .hero-card{background:rgba(2,6,23,.75)!important;border:1px solid rgba(255,255,255,.15)!important;}
.dark .hero-sub{color:#e5e7eb!important;}

/* ================= BACKGROUND ================= */
.paw-bg{
  position:fixed;inset:0;
  background-image:url("{% static 'img/paws4.jpeg' %}");
  background-size:100px;opacity:.12;
  animation:paws 90s linear infinite;
  pointer-events:none;z-index:-1;
}
@keyframes paws{from{background-position:0 0}to{background-position:2000px 2000px}}

/* ================= HERO ================= */
.hero-overlay{
  background:
    radial-gradient(circle at 30% 30%, rgba(236,72,153,.25), transparent 40%),
    radial-gradient(circle at 70% 60%, rgba(139,92,246,.25), transparent 40%),
    linear-gradient(to bottom, rgba(0,0,0,.65), rgba(0,0,0,.65));
}
.hero-content{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;text-align:center;z-index:5;padding:20px;}
.hero-card{padding:70px 80px;border-radius:40px;background:linear-gradient(145deg,rgba(255,255,255,.10),rgba(255,255,255,.03));backdrop-filter:blur(25px);border:1px solid rgba(255,255,255,.15);box-shadow:0 50px 140px rgba(0,0,0,.6);}
.hero-badge{display:inline-block;padding:10px 26px;border-radius:999px;background:linear-gradient(135deg,var(--pink),var(--purple));color:white;font-weight:700;margin-bottom:28px;}
.hero-title{font-size:3.5rem;font-weight:900;background:linear-gradient(90deg,#fff,#fde2f3,#e0e7ff);-webkit-background-clip:text;-webkit-text-fill-color:transparent;}
.hero-sub{font-size:1.2rem;color:#e5e7eb;max-width:720px;margin:28px auto 0;line-height:1.8;}

/* ================= CARDS ================= */
.card{background:linear-gradient(145deg,rgba(255,255,255,.95),rgba(255,255,255,.85));backdrop-filter:var(--blur);border-radius:28px;box-shadow:0 40px 90px rgba(0,0,0,.12);border:1px solid rgba(255,255,255,.4);}

/* ================= INPUTS ================= */
.input{width:100%;padding:18px 20px;border-radius:18px;border:1.5px solid #e5e7eb;background:rgba(255,255,255,.85);font-weight:500;}

/* ================= TIME GRID ================= */
.time-grid{
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(95px,1fr));
  gap:14px;
  margin-top:10px;
}
.time-btn{
  padding:12px 0;
  border-radius:14px;
  background:#fff;
  border:1px solid #e5e7eb;
  font-weight:700;
  cursor:pointer;
  transition:.25s;
}
.time-btn:hover{transform:translateY(-2px)}
.time-btn.active{
  background:linear-gradient(135deg,var(--pink),var(--purple));
  color:white;
  border-color:transparent;
}

/* ================= SUMMARY ================= */
.summary{background:linear-gradient(135deg,#fff1f8,#eef2ff);border-radius:32px;padding:36px;box-shadow:0 40px 100px rgba(0,0,0,.15);}
.total{font-size:2rem;font-weight:900;background:linear-gradient(90deg,var(--pink),var(--purple));-webkit-background-clip:text;-webkit-text-fill-color:transparent;}

/* ================= BUTTON ================= */
.premium-btn{background:linear-gradient(135deg,var(--pink),var(--purple));box-shadow:0 25px 60px rgba(236,72,153,.55);}
</style>
{% endblock %}

{% block content %}

<div class="paw-bg"></div>

<section class="relative h-[85vh] overflow-hidden">
  <video autoplay muted loop playsinline class="absolute inset-0 w-full h-full object-cover">
    <source src="{% static 'img/daycare.mp4' %}" type="video/mp4">
  </video>
  <div class="absolute inset-0 hero-overlay"></div>

  <div class="hero-content">
    <div class="hero-card">
      <div class="hero-badge">Welcome to PetPal Daycare</div>
      <h1 class="hero-title">Where Your Petâ€™s Day Feels Like Home</h1>
      <p class="hero-sub">Safe, loving and professional daycare for your pets.</p>
    </div>
  </div>
</section>

<section class="max-w-7xl mx-auto px-6 mt-32">

<form method="POST" action="{% url 'petapp:confirmbook' %}" id="daycareForm">
{% csrf_token %}

<div class="card p-14 max-w-5xl mx-auto mt-28">

  <h3 class="text-4xl font-extrabold mb-12 text-center">Pet & Owner Information</h3>

  <div class="grid md:grid-cols-2 gap-8">

    <input class="input" name="pet_name" placeholder="Pet name" required>

    <select class="input" id="petType" name="pet_type">
      <option value="Dog">Dog</option>
      <option value="Cat">Cat</option>
      <option value="Other">Other</option>
    </select>

    <input class="input md:col-span-2 hidden" id="otherAnimal" name="other_animal"
      placeholder="Specify animal (Rabbit, Parrot, etc)">

    <input class="input" name="pet_age" placeholder="Pet age">

    <input class="input" name="owner_name" placeholder="Owner name" required>

    <input class="input" name="phone" placeholder="Contact number" required>

    <input class="input md:col-span-2" name="email" placeholder="Email" required>

    <input class="input md:col-span-2" type="date" name="date" id="date" required>

    <select class="input md:col-span-2" id="duration" name="duration">
      <option value="half">Half Day</option>
      <option value="full" selected>Full Day</option>
      <option value="overnight">Overnight</option>
    </select>

  </div>

  <div class="mt-14">
    <label class="block text-sm font-semibold mb-4">Select Drop-off Time</label>
    <div class="time-grid" id="timeGrid"></div>
  </div>

</div>

<div class="summary max-w-xl mx-auto mt-20 text-center">
  <p>Selected Plan</p>
  <h3 id="planName">Standard</h3>
  <p id="durationName">FULL</p>
  <p>Total Amount</p>
  <div class="total">â‚¹<span id="total">899</span></div>

  <input type="hidden" name="plan" id="plan_input" value="Standard">
  <input type="hidden" name="total_cost" id="total_cost_input">
  <input type="hidden" name="start_time" id="start_time">
  <input type="hidden" name="end_time" id="end_time">

  <button class="block w-full py-5 text-white rounded-2xl font-bold text-lg premium-btn">
    Confirm Booking
  </button>
</div>

</form>
</section>

{% endblock %}

{% block extra_js %}
<script>
document.addEventListener("DOMContentLoaded",()=>{

let ALL_SLOTS=[];

/* ELEMENTS */
const petType=document.getElementById("petType");
const otherAnimal=document.getElementById("otherAnimal");
const duration=document.getElementById("duration");
const dateInput=document.getElementById("date");
const timeGrid=document.getElementById("timeGrid");

/* DISABLE PAST DATES */
const today=new Date();
dateInput.min=today.toISOString().split("T")[0];

/* OTHER ANIMAL */
petType.addEventListener("change",()=>{
  if(petType.value==="Other"){ otherAnimal.classList.remove("hidden"); }
  else{ otherAnimal.classList.add("hidden"); otherAnimal.value=""; }
});

/* BUILD SLOTS */
function buildSlots(){
  ALL_SLOTS=[];
  for(let h=10;h<=21;h++){
    ["00","30"].forEach(m=>{
      ALL_SLOTS.push(`${h.toString().padStart(2,"0")}:${m}`);
    });
  }
  ALL_SLOTS.push("22:00");
}
buildSlots();

/* ðŸ”¥ RENDER (HIDE BOOKED) */
function renderSlots(booked=[]){
  timeGrid.innerHTML="";

  const bookedSet = new Set(booked.map(t=>String(t).slice(0,5)));

  let count=0;

  ALL_SLOTS.forEach(time=>{
    if(bookedSet.has(time)) return;  // ðŸ”¥ HARD HIDE

    count++;

    const btn=document.createElement("button");
    btn.type="button";
    btn.className="time-btn";
    btn.innerText=time;

    btn.onclick=()=>{
      document.querySelectorAll(".time-btn").forEach(b=>b.classList.remove("active"));
      btn.classList.add("active");
      document.getElementById("start_time").value=time;
      document.getElementById("end_time").value=time;
    };

    timeGrid.appendChild(btn);
  });

  if(count===0){
    timeGrid.innerHTML = `
      <div style="grid-column:1/-1;text-align:center;
      padding:18px;background:#fee2e2;color:#b91c1c;
      border-radius:14px;font-weight:800;">
        No available slots for this date
      </div>
    `;
  }
}

/* API LOAD */
function loadSlots(date){
  fetch(`/api/daycare-slots/?date=${date}`)
    .then(r=>r.json())
    .then(d=>{
      console.log("BOOKED TIMES:", d.times);  // debug
      renderSlots(d.times || []);
    })
    .catch(e=>{
      console.error("API ERROR",e);
      renderSlots([]);
    });
}


/* DATE CHANGE */
dateInput.addEventListener("change",()=>{
  if(dateInput.value){
    loadSlots(dateInput.value);
  }
});

/* SUBMIT */
document.getElementById("daycareForm").addEventListener("submit",e=>{
  if(!document.getElementById("start_time").value){
    alert("Please select a time slot.");
    e.preventDefault();
  }
});

/* AUTO LOAD */
if(dateInput.value){
  loadSlots(dateInput.value);
}

});
</script>
{% endblock %}

